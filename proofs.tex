
\begin{proof}[Proof of \Cref{lem:structurelessSemantics}]
Let $P$ be a structureless pattern.
We perform induction on $P$.
If $P = \phi$, we get contradiction with the assumption that $P$ is structureless;
therefore, the conclusion holds by \emph{ex falso quodlibet}.
Other cases follow from the induction hypotheses.
\end{proof}


\begin{proof}[Proof of \Cref{lem:rhoStarOfPi}]
    By induction on the term $\pi$.
    \begin{itemize}
        \item $\pi = v$ for $v \in \mathit{Var}$ - follows from the definition of $\rho^*$.
        \item $\pi = f(\pi_1, \ldots, \pi_k)$ - we have $\rho(\pi_i) = \rho^*(\pi_i)$ for any $i \in \{ 1, \ldots, k \}$
              by the induction hypothesis.
              Then
              \begin{align*}
                  \rho^*(f(\pi_1, \ldots, \pi_k)) 
                  = & {\mathcal{T}^*}_f(\rho^*(\pi_1), \ldots, \rho^*(\pi_k)) \\
                  = & {\mathcal{T}^*}_f(\rho(\pi_1), \ldots, \rho(\pi_k)) \\
                  = & \mathcal{T}_f(\rho(\pi_1), \ldots, \rho(\pi_k)) \\
                  = & \rho(f(\pi_1, \ldots, \pi_k))
              \end{align*}
              where the second-to-last equality holds by definition of $\mathcal{T}^*$.
    \end{itemize}
\end{proof}


\begin{proof}[Proof of \Cref{lem:starConservative}]
By induction on $\varphi$.
\begin{itemize}
    \item $\varphi \equiv \pi$, where $\pi$ is a basic pattern (of sort $s$) - follows from \Cref{lem:rhoStarOfPi}.
    \item $\varphi \equiv \varphi_1 \land \varphi_2$ - follows from the induction hypothesis.
    \item $\varphi \equiv \neg \varphi^\prime$ - follows from the induction hypothesis.
    \item $\varphi \equiv \exists x : s^\prime.\, \varphi^\prime$. We have
    $ (\mathcal{T}^*, \gamma, \rho^\prime) \vDash \exists x : s^\prime.\, \varphi^\prime $
    if and only if (by definition of $\vDash$)
    there exists some valuation ${\rho^*}^\prime : \mathit{Var} \to \mathcal{T}^*$ such that
    $(\mathcal{T}^*, \gamma, {\rho^*}^\prime) \vDash \varphi^\prime$
    and ${\rho^*}^\prime(x) \in \mathcal{T}^*_{s^\prime}$\traian{you need to use $s'$ here and in the following.}
    and ${\rho^*}^\prime(y) = \rho^*(y)$ for all $y \in \mathit{Var} \setminus \{ x \}$.
    This holds if and only if
    there exists some valuation $\rho^{\prime} : \mathit{Var} \to \mathcal{T}$ such that
    $(\mathcal{T}^*, \gamma, {\rho^{\prime}}^*) \vDash \varphi^\prime$
    and ${\rho^{\prime}}^*(x) \in \mathcal{T}^*_s$
    and ${\rho^{\prime}}^*(y) = \rho^*(y)$ for all $y \in \mathit{Var} \setminus \{ x \}$:
    one implication follows by letting ${\rho^*}^\prime := \rho^{\prime}$;
    for the other implication, we let $\rho^{\prime}(v) := {\rho^*}^\prime(v)$ for all $v \in \mathit{Var}$,
    and by the definition of star, we have ${\rho^{\prime}}^*(v) = {\rho^*}^\prime(v)$, from which the rest follows.
    Next, by the induction hypothesis, this holds if and only if
    there exists some valuation $\rho^{\prime} : \mathit{Var} \to \mathcal{T}$ such that
    $(\mathcal{T}, \gamma, {\rho^{\prime}}) \vDash \varphi^\prime$
    and ${\rho^{\prime}}^*(x) \in \mathcal{T}^*_s$
    and ${\rho^{\prime}}^*(y) = \rho^*(y)$ for all $y \in \mathit{Var} \setminus \{ x \}$.
    Next, by the definition of ${\rho^\prime}^*$ and $\rho^*$, this holds if and only if
    there exists some valuation $\rho^{\prime} : \mathit{Var} \to \mathcal{T}$ such that
    $(\mathcal{T}, \gamma, {\rho^{\prime}}) \vDash \varphi^\prime$
    and ${\rho^{\prime}}(x) \in \mathcal{T}^*_s$
    and ${\rho^{\prime}}(y) = \rho(y)$ for all $y \in \mathit{Var} \setminus \{ x \}$.
    But since the star extensions interprets all sorts from $\Sigma$ as in the original model
    (that is, $\mathcal{T}^*_s = \mathcal{T}_s$),
    this is equivalent to the semantics of $(\mathcal{T}, \gamma, \rho) \vDash \exists x:s^\prime.\, \varphi^\prime$,
    which is what we wanted to prove.

    Alternate attempt:
    The induction hypothesis is: for any $\mathcal{T}$, $\gamma$, $\rho$, 
        $$(\mathcal{T}, \gamma, \rho) \vDash \varphi' \iff (\mathcal{T}^*, \gamma, \rho^\ast) \vDash \varphi'$$
    We want to prove that for any $\mathcal{T}$, $\gamma$, $\rho$, 
        $$(\mathcal{T}, \gamma, \rho) \vDash \exists x:s'. \varphi' \iff (\mathcal{T}^*, \gamma, \rho^\ast) \vDash \exists x:s'.\varphi'$$
    
    First, let us prove the left-to-right implication.
    The left-hand-side of the claim is equivalent with
    $$\exists \rho'. (\forall y. y \neq x \to \rho'(y) = \rho(y)) \wedge (T, \gamma, \rho') \vDash \varphi'$$
    From the induction hypothesis, this is further equivalent with
    $$\exists \rho'. (\forall y. y \neq x \to \rho'(y) = \rho(y)) \wedge (T^\ast, \gamma, {\rho'}^\ast) \vDash \varphi'$$
    
    Since $\forall y. y \neq x \to {\rho'}^\ast(y) = \rho'(y) = \rho(y) = \rho^\ast(y)$, we deduce $(\mathcal{T}^*, \gamma, \rho^\ast) \vDash \exists x:s'.\varphi'$.
    
    Conversely, the right-hand-side of the claim is equivalent with
    $$\exists \rho''. (\forall y. y \neq x \to \rho'(y) = \rho\ast(y)) \wedge (T^\ast, \gamma, \rho'') \vDash \varphi'$$
    Let $\rho'$ be defined by $\rho'(y) = \rho(y)$ if $y\neq x$ and $\rho'(x) = \rho''(x)$. Then it is
    easy to see that ${\rho'}^\ast = \rho''$, whence by the induction hypothesis we obtain that
    $(T, \gamma, \rho') \vDash \varphi'$, and by the definition of $\rho'$, $(T, \gamma, \rho) \vDash \exists x:s'. \varphi'$.
 \end{itemize}
\end{proof}

\begin{lemma}\label{lem:simplifyComposite}
We have
\begin{proofenv}
    \begin{equation*}
        C \Rightarrow_{\mathcal{S}^*} C^\prime
    \end{equation*}
\end{proofenv}
    if and only if
\begin{proofenv}
    there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
    and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
    \begin{itemize}
        \item $(\mathcal{T}^*, \rho) \vDash P$; and
        \item $(\mathcal{T}^*, \rho) \vDash P^\prime$; and
        \item $C = \rho(L) \texttt{++} [\rho(\phi)] \texttt{++} \rho(R)$; and
        \item $C^\prime = \rho(L) \texttt{++} [\rho(\phi^\prime)] 
        \texttt{++} \rho(R)$,
    \end{itemize}
\end{proofenv}
\end{lemma}
\begin{proof}
We have
\begin{proofenv}
    \begin{equation*}
        C \Rightarrow_{\mathcal{S}^*} C^\prime
    \end{equation*}
\end{proofenv}
iff (by \Cref{def:basics})
\begin{proofenv}
    there exists a rule $\varphi \Rightarrow^\exists \varphi^\prime \in S^*$
    and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
    $(\mathcal{T}^*, C, \rho) \vDash \varphi$
    and $(\mathcal{T}^*, C^\prime, \rho) \vDash \varphi^\prime$,
\end{proofenv}
iff (by
%\Cref{def:matchinglogic} and
\Cref{rem:shapeOfReachabilityRules} and \Cref{def:starextension})
\begin{proofenv}
    there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
    and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
    \begin{equation*}
    (\mathcal{T}^*, C, \rho) \vDash \mathit{cfgheat}(L, \phi, R) \land P
    \end{equation*}
    and
    \begin{equation*}
        (\mathcal{T}^*, C^\prime, \rho) \vDash
        \mathit{cfgheat}(L, \phi^\prime, R) \land P^\prime \, ,
    \end{equation*}
\end{proofenv}
iff (by \Cref{def:matchinglogic} and \Cref{lem:structurelessSemantics})
\begin{proofenv}
    there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
    and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
    $(\mathcal{T}^*, \rho) \vDash P$ and $(\mathcal{T}^*, \rho) \vDash P^\prime$ and
    \begin{equation*}
        (\mathcal{T}^*, C, \rho) \vDash \mathit{cfgheat}(L, \phi_l, R)
    \end{equation*}
    and
    \begin{equation*}
        (\mathcal{T}^*, C^\prime, \rho) \vDash
        \mathit{cfgheat}(L, \phi^\prime_j, R) \, ,
    \end{equation*}
\end{proofenv}
iff (by \Cref{def:matchinglogic} and \Cref{def:starextension})
\begin{proofenv}
    there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
    and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
    \begin{itemize}
        \item $(\mathcal{T}^*, \rho) \vDash P$; and
        \item $(\mathcal{T}^*, \rho) \vDash P^\prime$; and
        \item $C = \rho(L) \texttt{++} [\rho(\phi)] \texttt{++} \rho(R)$; and
        \item $C^\prime = \rho(L)
        \texttt{++} [\rho(\phi^\prime)] \texttt{++} \rho(R)$.
    \end{itemize}
\end{proofenv}
That proves the desired equivalence.
\end{proof}


\begin{proof}[Proof of \Cref{lem:compositeStep}]
We have
\begin{proofenv}
\begin{equation*}
[c_1,\ldots,c_k] \Rightarrow_{\mathcal{S}^*} [c_1, \ldots, c_{i-1}, c^\prime, c_{i+1}, \ldots, c_k]    
\end{equation*}
\end{proofenv}
iff (by \Cref{lem:simplifyComposite})
\begin{proofenv}
there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
\begin{itemize}
    \item $(\mathcal{T}^*, \rho) \vDash P$; and
    \item $(\mathcal{T}^*, \rho) \vDash P^\prime$; and
    \item $[c_1,\ldots,c_k] = \rho(L) \texttt{++} [\rho(\phi_l)] \texttt{++} \rho(R)$; and
    \item $[c_1, \ldots, c_{i-1}, c^\prime, c_{i+1}, \ldots, c_k] = \rho(L) \texttt{++} [\rho(\phi_j)] 
    \texttt{++} \rho(R)$.
\end{itemize}
\end{proofenv}
Suppose we have such valuation $\rho$.
We can surely construct valuation $\rho_0 : \mathit{Var} \to \mathcal{T}$ by letting
\begin{equation*}
\rho_0(v)=
    \begin{cases}
        \rho(v) & \text{if } \rho(v) \in \mathcal{T}\\
        a & \text{if } \rho(v) \not\in \mathcal{T}
    \end{cases}
\end{equation*}
(where $a \in \mathcal{T}$ is some arbitrary element).
Now, for any $v \in \mathit{FV}(\phi) \cup \mathit{FV}(\phi^\prime) \cup \mathit{FV}(P) \cup \mathit{FV}(P^\prime)$ it holds that
$((\rho_0)^*)(v) = \rho(v)$.
Why? Because $v$ has some sort $s$ from $\Sigma$
(that is, $s \not = \mathit{Cfg}^*$).
Therefore, we can use \Cref{lem:unusedVariables} to change the goal to one saying that
\begin{proofenv}
there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
and valuation $\rho_0 : \mathit{Var} \to \mathcal{T}$ such that
\begin{itemize}
    \item $(\mathcal{T}^*, (\rho_0)^*) \vDash P$; and
    \item $(\mathcal{T}^*, (\rho_0)^*) \vDash P^\prime$; and
    \item $[c_1,\ldots,c_k] = ((\rho_0)^*)(L) \texttt{++} [((\rho_0)^*)(\phi_l)] \texttt{++} ((\rho_0)^*)(R)$; and
    \item $[c_1, \ldots, c_{i-1}, c^\prime, c_{i+1}, \ldots, c_k] = ((\rho_0)^*)(L)
    \texttt{++} [((\rho_0)^*)(\phi_j)] 
    \texttt{++} ((\rho_0)^*)(R)$
\end{itemize}
\end{proofenv}
(where the opposite implication follows by choice $\rho := (\rho_0)^*$).
Now, we use \Cref{lem:starConservative} and definition of starred valuation to change the goal to one saying that
\begin{proofenv}
there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
and valuation $\rho_0 : \mathit{Var} \to \mathcal{T}$ such that
\begin{itemize}
    \item $(\mathcal{T}, \rho_0) \vDash P$; and
    \item $(\mathcal{T}, \rho_0) \vDash P^\prime$; and
    \item $[c_1,\ldots,c_k] = \rho_0(L) \texttt{++} [\rho_0(\phi_l)] \texttt{++} \rho_0(R)$; and
    \item $[c_1, \ldots, c_{i-1}, c^\prime, c_{i+1}, \ldots, c_k] = \rho_0(L)
    \texttt{++} [\rho_0(\phi_j)] 
    \texttt{++} \rho_0(R)$.
\end{itemize}
\end{proofenv}
Now, by list reasoning, this is equivalent to
saying that
\begin{proofenv}
there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
and valuation $\rho_0 : \mathit{Var} \to \mathcal{T}$ such that
there exists some $i^\prime$ satisfying $1 \leq i^\prime \leq k$
such that
\begin{itemize}
    \item $(\mathcal{T}, \rho_0) \vDash P_l$; and
    \item $(\mathcal{T}, \rho_0) \vDash P_j$; and
    \item $[c_1,\ldots, c_{i^\prime-1}] = \rho_0(L)$; and
    \item $c_{i^\prime} = \rho_0(\phi_l)$; and
    \item $[c_{i^\prime+1},\ldots,c_k] = \rho_0(R)$; and
    \item $[c_1, \ldots, c_{i-1}, c^\prime, c_{i+1}, \ldots, c_k] = \rho_0(L)
    \texttt{++} [\rho_0(\phi_j)] 
    \texttt{++} \rho_0(R)$.
\end{itemize}
\end{proofenv}
Now, let us define $c^\prime_{z}$ by
\begin{equation*}
c^\prime_{z} =
    \begin{cases}
        c^\prime & \text{if } z = i \\
        c_z & \text{if } z \not = i
    \end{cases}
\end{equation*}
after which the goal is equivalent to saying that
\begin{proofenv}
there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
and valuation $\rho_0 : \mathit{Var} \to \mathcal{T}$ such that
there exists some $i^\prime$ satisfying $1 \leq i^\prime \leq k$ such that
\begin{itemize}
    \item $(\mathcal{T}, \rho_0) \vDash P$; and
    \item $(\mathcal{T}, \rho_0) \vDash P^\prime$; and
    \item $[c_1,\ldots, c_{i^\prime-1}] = \rho_0(L)$; and
    \item $c_{i^\prime} = \rho_0(\phi)$; and
    \item $[c_{i^\prime+1},\ldots,c_k] = \rho_0(R)$; and
    \item $[c^\prime_1,\ldots, c^\prime_{i^\prime-1}] = \rho_0(L)$; and
    \item $c^\prime_{i^\prime} = \rho_0(\phi^\prime)$; and
    \item $[c^\prime_{i^\prime+1},\ldots,c^\prime_k] = \rho_0(R)$.
\end{itemize}
\end{proofenv}
Since $L,R$ were fresh, they do not occur in $\phi$ nor in $\phi^\prime$.
Therefore, using \Cref{lem:unusedVariables}, we can equivalently say that
\begin{proofenv}
there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
and valuation $\rho_0 : \mathit{Var} \to \mathcal{T}$ such that
there exists some $i^\prime$ satisfying $1 \leq i^\prime \leq k$
such that
\begin{itemize}
    \item $(\mathcal{T}, \rho_0) \vDash P$; and
    \item $(\mathcal{T}, \rho_0) \vDash P^\prime$; and
    \item $c_{i^\prime} = \rho_0(\phi_l)$; and
    \item $c^\prime_{i^\prime} = \rho_0(\phi_j)$.
\end{itemize}
\end{proofenv}
(The downwards implication is trivial, as it is only removing constraints; the upwards implication
is from the fact that we can always choose a valuation $\rho_0$ satisfying the constraints.)
But that is equivalent (\Cref{def:matchinglogic}) to saying that 
\begin{proofenv}
there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
and there exists some $i^\prime$ satisfying $1 \leq i^\prime \leq k$
and valuation $\rho_0 : \mathit{Var} \to \mathcal{T}$ such that
\begin{itemize}
    \item $(\mathcal{T}, c_{i^\prime}, \rho_0) \vDash \phi \land P$; and
    \item $(\mathcal{T}, c^\prime_{i^\prime}, \rho_0) \vDash \phi^\prime \land P^\prime$
    .
\end{itemize}
\end{proofenv}
But that is
equivalent to saying that
\begin{proofenv}
there exists some $i^\prime$ satisfying $1 \leq i^\prime \leq k$
such that $c_{i^\prime} \Rightarrow_{\mathcal{S}} c^\prime_{i^\prime}$,
\end{proofenv}
which is almost equivalent to the left side of the equivalence we want to prove:
that
\begin{proofenv}
$c_{i} \Rightarrow_{\mathcal{S}} c^\prime_{i}$.
\end{proofenv}
The upwards implication is trivial; the downwards is as follows. If $i = i^\prime$, we are done.
But otherwise, it would follow (by definition of $c^\prime_{i^\prime}$) that $c_{i^\prime} \Rightarrow_{\mathcal{S}} c_{i^\prime}$,
which contradicts \Cref{rem:noEmptySteps}.
\end{proof}

\begin{lemma}\label{lem:mkListSemantics}
$(\mathcal{T}^*, C, \rho) \vDash \mathit{mkList}(\phi_1,\ldots,\phi_k)$
iff there exists $c_1, \ldots, c_k \in \Tcfg$ such that $C = [c_1, \ldots, c_k]$ and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
$\rho^\prime(v) = \rho(v)$ for any \\
$v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_k))$,
it holds that 
$(\mathcal{T}, c_1, \rho^\prime) \vDash \phi_1$ and \ldots and $(\mathcal{T}, c_k, \rho^\prime) \vDash \phi_k$.
\end{lemma}
\begin{proof}
By induction on $k$.
\begin{itemize}
    \item If $k = 1$, then we have to prove that
    \begin{proofenv}
    $(\mathcal{T}^*, C, \rho) \vDash \mathit{cfgitem}(\phi_1)$
    iff there exists $c_1 \in \Tcfg$ such that $C = [c_1]$ and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any $v \in \mathit{FV}(\mathit{cfgitem}(\phi_1))$, it holds that
    $(\mathcal{T}, c, \rho^\prime) \vDash \phi_1$.
    \end{proofenv}
    By \cref{def:matchinglogic}, this is equivalent to
    \begin{proofenv}
    $C = \rho(\mathit{cfgitem}(\phi_1))$
    iff there exists $c_1 \in \Tcfg$ such that $C = [c_1]$ and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any $v \in \mathit{FV}(\mathit{cfgitem}(\phi_1))$, it holds that
    $c_1 = \rho^\prime(\phi_1)$.
    \end{proofenv}
    By \Cref{def:starextension}, this is equivalent to
    \begin{proofenv}
    $C = [\rho(\phi_1)]$
    iff there exists $c_1 \in \Tcfg$ such that $C = [c_1]$ and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any $v \in \mathit{FV}(\mathit{cfgitem}(\phi_1))$, it holds that
    $c_1 = \rho^\prime(\phi_1)$.
    \end{proofenv}
    We prove each implication separately.
    For the left-to-right implication, we let $c_1 := \rho(\phi_1)$
    and have to prove that $\rho(\phi_1) = \rho^\prime(\phi_1)$, which follows from \Cref{lem:unusedVariables}.
    The right-to-left implication also follows from  \Cref{lem:unusedVariables}.
    
    \item If $k = k^\prime + 1$, we assume the induction hypothesis saying that
    \begin{proofenv}
    for every $C, \phi_1, \ldots, \phi_{k^\prime}$,
    $(\mathcal{T}^*, C, \rho) \vDash \mathit{mkList}(\phi_1,\ldots,\phi_{k^\prime})$
    iff there exists $c_1, \ldots, c_{k^\prime} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime}))$,
    it holds that
    $(\mathcal{T}, c_1, \rho^\prime) \vDash \phi_1$ and \ldots and $(\mathcal{T}, c_{k^\prime}, \rho^\prime) \vDash \phi_k$,
    \end{proofenv}
    and have to prove that
    \begin{proofenv}
    $(\mathcal{T}^*, C, \rho) \vDash \mathit{mkList}(\phi_1,\ldots,\phi_{k^\prime + 1})$
    iff there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$ and 
    for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
    it holds that
    $(\mathcal{T}, c_1, \rho^\prime) \vDash \phi_1$ and \ldots and $(\mathcal{T}, c_{k^\prime + 1}, \rho^\prime) \vDash \phi_{k^\prime + 1}$,
    \end{proofenv}
    which is (by \Cref{def:matchinglogic}) equivalent to
    \begin{proofenv}
    $C = \rho(\mathit{mkList}(\phi_1,\ldots,\phi_{k^\prime + 1}))$
    iff there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
    it holds that
    $c_1 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime + 1} = \rho^\prime(\phi_{k^\prime + 1})$,
    \end{proofenv}
    which is (by \Cref{def:starextension}) equivalent to
    \begin{proofenv}
    $C = [\rho(\phi_1)] \texttt{++} C^\prime$ and $C^\prime = \rho(\mathit{mkList}(\phi_2,\ldots,\phi_{k^\prime + 1}))$
    iff there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
    it holds that
    $c_1 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime + 1} = \rho^\prime(\phi_{k^\prime + 1})$,
    \end{proofenv}
    which is by the induction hypothesis with $\phi_1 := \phi_2,\ldots,\phi_k := \phi_{k^\prime + 1}$
    and $\alpha$-renaming
    equivalent to
    \begin{proofenv}
    $C = [\rho(\phi_1)] \texttt{++} C^\prime$ and
    there exists $c_2, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C^\prime = [c_2, \ldots, c_{k^\prime+1}]$ 
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_2, \ldots, \phi_{k^\prime+1}))$,
    it holds that
    $(\mathcal{T}, c_2, \rho^\prime) \vDash \phi_2$ and \ldots and $(\mathcal{T}, c_{k^\prime+1}, \rho^\prime) \vDash \phi_{k^\prime + 1}$,
    iff there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
    it holds that
    $c_1 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime + 1} = \rho^\prime(\phi_{k^\prime + 1})$,
    \end{proofenv}
    which is (by firstorder reasoning and simplification of list append) equivalent to
    \begin{proofenv}
    there exists $c_2, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that
    $C = [\rho(\phi_1), c_2, \ldots, c_{k^\prime+1}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_2, \ldots, \phi_{k^\prime+1}))$,
    it holds that
    $(\mathcal{T}, c_2, \rho^\prime) \vDash \phi_2$ and \ldots and $(\mathcal{T}, c_{k^\prime+1}, \rho^\prime) \vDash \phi_{k^\prime+1}$,
    iff there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
    it holds that
    $c_1 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime + 1} = \rho^\prime(\phi_{k^\prime + 1})$.
    \end{proofenv}
    We simplify the goal using \Cref{def:matchinglogic} to
    \begin{proofenv}
    there exists $c_2, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that
    $C = [\rho(\phi_1), c_2, \ldots, c_{k^\prime+1}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_2, \ldots, \phi_{k^\prime+1}))$,
    it holds that
    $c_2 = \rho^\prime(\phi_2)$ and \ldots and $c_{k^\prime+1} = \rho^\prime(\phi_{k^\prime+1})$,
    iff there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$
    and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
    $\rho^\prime(v) = \rho(v)$ for any
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
    it holds that
    $c_1 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime + 1} = \rho^\prime(\phi_{k^\prime + 1})$.
    \end{proofenv}
    We prove each implication separately.
    \begin{itemize}
        \item Assuming
        \begin{proofenv}
        there exists $c_2, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that
        $C = [\rho(\phi_1), c_2, \ldots, c_{k^\prime+1}]$
        and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
        $\rho^\prime(v) = \rho(v)$ for any
        $v \in \mathit{FV}(\mathit{mkList}(\phi_2, \ldots, \phi_{k^\prime+1}))$,
        it holds that
        $c_2 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime+1} = \rho^\prime(\phi_k)$,
        \end{proofenv}
        we prove that
        \begin{proofenv}
        there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$
        and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
        $\rho^\prime(v) = \rho(v)$ for any
        $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
        it holds that
        $c_1 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime + 1} = \rho^\prime(\phi_{k^\prime + 1})$.
        \end{proofenv}
        by choosing $c_1 := \rho^\prime(\phi_1)$ and using \Cref{lem:unusedVariables}\\
        (note that $\mathit{FV}(\mathit{mkList}(\phi_2,\ldots,\phi_{k^\prime+1})) \subseteq \mathit{FV}(\mathit{mkList}(\phi_1,\ldots,\phi_{k^\prime+1}))$).
        \item Assuming
        \begin{proofenv}
        there exists $c_1, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that $C = [c_1, \ldots, c_{k^\prime + 1}]$
        and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
        $\rho^\prime(v) = \rho(v)$ for any
        $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_{k^\prime + 1}))$,
        it holds that
        $c_1 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime + 1} = \rho^\prime(\phi_{k^\prime + 1})$,
        \end{proofenv}
        we prove that
        \begin{proofenv}
        there exists $c_2, \ldots, c_{k^\prime + 1} \in \Tcfg$ such that
        $C = [\rho(\phi_1), c_2, \ldots, c_{k^\prime+1}]$
        and for every $\rho^\prime : \mathit{Var} \to \mathcal{T}$ satisfying
        $\rho^\prime(v) = \rho(v)$ for any
        $v \in \mathit{FV}(\mathit{mkList}(\phi_2, \ldots, \phi_{k^\prime+1}))$,
        it holds that
        $c_2 = \rho^\prime(\phi_1)$ and \ldots and $c_{k^\prime+1} = \rho^\prime(\phi_k)$
        \end{proofenv}
        by setting $c_i := c_i$
        (and again noting that $\mathit{FV}(\mathit{mkList}(\phi_2,\ldots,\phi_{k^\prime+1})) \subseteq \mathit{FV}(\mathit{mkList}(\phi_1,\ldots,\phi_{k^\prime+1}))$).
    \end{itemize}
\end{itemize}
\end{proof}

\begin{lemma}\label{lem:transitionOnlyBetweenListsOfSameLength}
    Let $\mathcal{S} = (\mathcal{T}, S)$ be a reachability system over $(\Sigma, \mathit{Cfg})$.
    Then for any $C,C^\prime \in \mathcal{T}^*_{\mathit{Cfg}^*}$,
    if $C \Rightarrow_{\mathcal{S}^*} C^\prime$,
    then the length of $C$ (it is a list) is the same as the length of $C^\prime$.
\end{lemma}
\begin{proof}
Assume $C \Rightarrow_{\mathcal{S}^*} C^\prime$.
Then by \Cref{lem:simplifyComposite},
\begin{proofenv}
    there exists a rule $\phi \land P_l \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
    and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
    \begin{itemize}
        \item $(\mathcal{T}^*, \rho) \vDash P$; and
        \item $(\mathcal{T}^*, \rho) \vDash P^\prime$; and
        \item $C = \rho(L) \texttt{++} [\rho(\phi)] \texttt{++} \rho(R)$; and
        \item $C^\prime = \rho(L) \texttt{++} [\rho(\phi^\prime)] 
        \texttt{++} \rho(R)$.
    \end{itemize}
\end{proofenv}
But then $C$ and $C^\prime$ have the same length.
\end{proof}

\begin{lemma}[At most one component changes]\label{lem:atMostOneComponentChanges}
    Let $\mathcal{S} = (\mathcal{T}, S)$ be a reachability system over $(\Sigma, \mathit{Cfg})$.
    Then for any $C,C^\prime \in \mathcal{T}^*{\mathit{Cfg}^*}$ satisfying $C \Rightarrow_{\mathcal{S}^*} C^\prime$
    there exists some $i \in \mathbb{N}$ such that
    for every $i^\prime \in \mathbb{N}$ such that $i^\prime \not = i$,
    we have $C[i^\prime] = C^\prime[i^\prime]$ if both are defined.
\end{lemma}
\begin{proof}
Assume $C \Rightarrow_{\mathcal{S}^*} C^\prime$.
Then by \Cref{lem:simplifyComposite},
\begin{proofenv}
    there exists a rule $\phi \land P \Rightarrow^\exists \phi^\prime \land P^\prime \in S$
    and valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
    \begin{itemize}
        \item $(\mathcal{T}^*, \rho) \vDash P_l$; and
        \item $(\mathcal{T}^*, \rho) \vDash P_j$; and
        \item $C = \rho(L) \texttt{++} [\rho(\phi)] \texttt{++} \rho(R)$; and
        \item $C^\prime = \rho(L) \texttt{++} [\rho(\phi^\prime)] 
        \texttt{++} \rho(R)$.
    \end{itemize}
\end{proofenv}
But then we can let $i := |\rho(L)|$, and the rest follows.
\end{proof}


The following definition and theorem on filtering infinite sequences
are based on the Coq development of \cite{ZamfirVLSM}
(specifically, on \url{https://github.com/runtimeverification/vlsm/blob/d6c8cee56708c7be2431b9743fe80ca6a7a29a58/theories/VLSM/Lib/StreamFilters.v}).
\begin{definition}[Filtering subsequence]\label{def:filteringSubsequence}
Given a set $A$, a subset $P \subseteq A$ and a function $s : \mathbb{N} \to A$,
a function $\mathit{ns} : \mathbb{N} \to \mathbb{N}$ is called a filtering subsequence for $P$ on $s$,
iff
\begin{enumerate}
    \item $\mathit{ns}$ is monotone;
    \item $s(x) \not \in P$ for any $x < ns(0)$;
    \item $s(\mathit{ns}(j)) \in P$ for any $j \in \mathbb{N}$; and
    \item for every $j \in \mathbb{N}$ and every $x$ such that $\mathit{ns}(j) < x < \mathit{ns}(j+1)$,
          $s(x) \not\in P$.
\end{enumerate}
Intuitively, the last condition says that $ns$ does not skip any $P$-element in $s$.
\end{definition}

\begin{lemma}[Existence of filtering sequence for infinite occurrences]\label{lem:filteringSubsequenceExistsForInfinite}
    Let $A$ be a set, let $P \subseteq A$, and let $s : \mathbb{N} \to A$ be a function whose output
    falls to $P$ infinitely often (that is, $s(i) \in P$ for infinitely many $i$).
    Then there exists a filtering subsequence for $P$ on $s$.
\end{lemma}

\begin{lemma}\label{lem:terminationComposite}
    For any reachability system $\mathcal{S} = (\mathcal{T}, S)$, any $C \in \mathcal{T}^*_{\mathit{Cfg}^*}$,
    and any $c_1,\ldots,c_k \in \Tcfg$ such that
    $C = [c_1,\ldots,c_k]$, $C$ is terminating in $(\mathcal{T}^*_{\mathit{Cfg}^*}, \Rightarrow_{S^*})$
    iff for every $j \in \{ 1, \ldots, k \}$, $c_j$ is terminating in $(\Tcfg, \Rightarrow_S)$.
\end{lemma}
\begin{proof}[Proof of \Cref{lem:terminationComposite}]
We prove both implications separately, by contraposition.
\begin{itemize}
    \item Suppose some $c_j$ is not terminating in $(\Tcfg, \Rightarrow_S)$.
    In other words, there exists some infinite $\Rightarrow_{\mathcal{S}}$-sequence
    $c_j = d(0) \Rightarrow_{\mathcal{S}} d(1) \Rightarrow_{\mathcal{S}} d(2) \Rightarrow_{\mathcal{S}} \ldots$.
    Then $C = [c_1,\ldots,c_{j-1}, d(0), c_{j+1}, \ldots, c_k] \Rightarrow_{\mathcal{S}^*}
    [c_1,\ldots,c_{j-1}, d(1), c_{j+1}, \ldots, c_k] \Rightarrow_{\mathcal{S}^*} \ldots$
    is (by \Cref{lem:compositeStep}) an infinite $\Rightarrow_{\mathcal{S}^*}$-sequence.
    Therefore, $C$ is not terminating in $(\mathcal{T}^*_{\mathit{Cfg}^*}, \Rightarrow_{S^*})$.
    \item Suppose $C$ is not terminating in $(\mathcal{T}^*_{\mathit{Cfg}^*}, \Rightarrow_{S^*})$.
    In other words, there exists an infinite sequence $C = D(0) \Rightarrow_{\mathcal{S}^*} D(1) \Rightarrow_{\mathcal{S}^*} \ldots$.
    Then there exists a component $j$ of the sequence which changes infinitely often in the sequence,
    because we have only $k$ components.
    Now, consider the function $s : \mathbb{N} \to \mathcal{T}^*_{\mathit{Cfg}^*} \times \mathcal{T}^*_{\mathit{Cfg}^*}$
    defined by $s(i) = (D(i), D(i+1))$, and let $P \subseteq \mathcal{T}^*_{\mathit{Cfg}^*} \times \mathcal{T}^*_{\mathit{Cfg}^*}$
    be defined by $(X, X^\prime) \in P$ iff $X[j] \not = X^\prime[j]$.
    By \Cref{lem:atMostOneComponentChanges}, we know that whenever $(X, X^\prime) \in P$,
    then for any $j^\prime$ satisfying $1 \leq j^\prime \leq k$ and $j^\prime \not = j$,
    we have $X[j^\prime] = X^\prime[j^\prime]$.
    Then, $s(i) \in P$ iff in the sequence $C$, on position $i$, it is exactly the $j$th component (and no other)
    which makes step.
    Now, by \Cref{lem:filteringSubsequenceExistsForInfinite}, there exists a filtering subsequence $\mathit{ns}$
    for $P$ on $s$.
    But then
    \begin{equation*}
        D(\mathit{ns}(0))[j] \Rightarrow_S D(\mathit{ns}(1))[j] \Rightarrow_S D(\mathit{ns}(2))[j] \Rightarrow_S \ldots
    \end{equation*}
    is a $(\Tcfg, \Rightarrow_S)$ sequence witnessing the non-termination of $D(0)[j] = c_j$.
    Indeed, we have
    \begin{itemize}
        \item $D(\mathit{ns}(0))[j] = D(0)[j]$, by (2) of \Cref{def:filteringSubsequence}, the definition of $P$,
        and transitivity of equality;
        \item for any $i \in \mathbb{N}$, $D(\mathit{ns}(i))[j] \Rightarrow_{\mathcal{S}} D(\mathit{ns}(i+1))[j]$.
        We prove this as follows. By
        (4) of \Cref{def:filteringSubsequence} and definition of $P$ we have
        $D(\mathit{ns}(i+1))[j] = D(\mathit{ns}(i)+1)[j]$.
        Therefore, it is enough to show that
        \begin{equation*}
            D(\mathit{ns}(i))[j] \Rightarrow_{\mathcal{S}} D(\mathit{ns}(i)+1)[j] \, .
        \end{equation*}
        By (3) of \Cref{def:filteringSubsequence} and definition of $P$ we have
        $D(\mathit{ns}(i))[j] \not = D(\mathit{ns}(i)+1)[j]$.
        By \Cref{lem:compositeStep}, it is enough to show that there exists $k \geq 1$,
        $c_1,\ldots,c_k,c^\prime \in \Tcfg$, and some $i$ satisfying $1 \leq i \leq k$,
        such that
        $[c_1,\ldots,c_k] = D(\mathit{ns}(i))$
        and
        $[c_1,\ldots,c_{i-1},c^\prime,c_{i+1},c_k] = D(\mathit{ns}(i) + 1)$.
        But that follows from the fact that $D(\mathit{ns}(i)) \Rightarrow_{\mathcal{S}^*} D(\mathit{ns}(i) + 1)$
        and that $D(\mathit{ns}(i))[j] \not = D(\mathit{ns}(i)+1)[j]$
        by \Cref{lem:transitionOnlyBetweenListsOfSameLength} and \Cref{lem:atMostOneComponentChanges}.
    \end{itemize}
\end{itemize}
\end{proof}


\begin{lemma}\label{lem:reachComposite}
    For any reachability system $\mathcal{S} = (\mathcal{T}, S)$, any $C,C^\prime \in \mathcal{T}^*_{\mathit{Cfg}^*}$,
    and any $c_1,\ldots,c_k,c_1^\prime,\ldots,c_k^\prime \in \Tcfg$ such that
    $C = [c_1,\ldots,c_k]$ and $C^\prime = [c_1^\prime,\ldots,c_k^\prime]$,
    $C \Rightarrow^*_{\mathcal{S}^*} C^\prime$ iff for every $i \in \{ 1, \ldots, k \}$,
    $c_i \Rightarrow^*_{\mathcal{S}} c_i^\prime$.
\end{lemma}
\begin{proof}[Proof of \Cref{lem:reachComposite}]
We prove each implication separately.
\begin{itemize}
    \item For the "if" implication, we assume that $c_i \Rightarrow_{\mathcal{S}}^* c_i^\prime$
          for any $i \in \{ 1, \ldots, k \}$,
          and have to prove that $[c_1,\ldots,c_k] \Rightarrow_{\mathcal{S}^*}^* [c_1^\prime,\ldots,c_k^\prime]$.
          We will prove that for any $j \in \{ 1, \ldots, k \}$, we it holds that
          \begin{equation*}
           [c^\prime_1,\ldots,c^\prime_{j-1}, c_j, c_{j+1}, \ldots, c_k] \Rightarrow_{\mathcal{S}^*}^* [c^\prime_1,\ldots,c^\prime_{j-1}, c_j^\prime, c_{j+1}, \ldots, c_k]    \, ,
          \end{equation*}
          from which the goal follows by transitivity.
          Ok then, let $j \in \{ 1, \ldots, k \}$.
          By \Cref{lem:compositeStep}, it is enough to prove that $c_j \Rightarrow^*_{\mathcal{S}} c_j^\prime$.
          But that holds by the assumption.
    \item For the "only if" implication, we assume $C \Rightarrow^*_{\mathcal{S}^*} C^\prime$,
          $i \in \{ 1,\ldots,k \}$, and have to prove that $c_i \Rightarrow^*_{\mathcal{S}} c_i^\prime$.
          Let $C_1,\ldots,C_l \in \mathcal{T}^*_{\mathit{Cfg}^*}$ be a sequence witnessing $C \Rightarrow^*_{\mathcal{S}^*} C^\prime$;
          that is, we have $C = C_1$, $C_l = C^\prime$, and $C_j \Rightarrow_{\mathcal{S}^*} C_{j+1}$ for any $j \in \{ 1, \ldots, l-1 \}$.
          Let $i_1,\ldots,i_m \in \{ 1,\ldots,l-1 \}$ be a strictly increasing sequence of maximal length such that
          $C_{i_j}[i] \not = C_{i_j + 1}[i]$ for any $j \in \{ 1,\ldots,m \}$;
          that is, the sequence of positions in the witnessing sequence when the component $i$ changes.
          Then clearly, $C_1[i] = C_{i_1}[i]$ (otherwise we could create a longer sequence).
          Similarly, $C_l[i] = C_{i_m}[i]$.
          Now we claim that $C_{i_1}[i] \Rightarrow_{\mathcal{S}} \ldots \Rightarrow_{\mathcal{S}} C_{i_m}[i]$,
          from which the conclusion easily follows.
          We have to prove that for any $o \in \{ 1, \ldots, m \}$, it holds that
          $C_{i_o}[i] \Rightarrow_{\mathcal{S}} C_{i_{o+1}}[i]$.
          Let $d := i_{o+1} - i_{o}$; clearly, we have $d > 0$.
          By the definition of $d$, we have $C_{i_{o+1}}[i] = C_{i_{o} + d}[i]$.
          By definition of the sequence, in particular by maximality, we have $C_{i_{o} + d}[i] = C_{i_{o} + 1}[i]$
          (because there can be no change of the component $i$ between the change at the position $i_o$ and the change at the position $i_{o+1}$).
          Therefore, it is enough to show that
          $C_{i_o}[i] \Rightarrow_{\mathcal{S}} C_{i_{o}+1}[i]$.
          By \Cref{lem:compositeStep} (using also \Cref{lem:atMostOneComponentChanges} and \Cref{lem:transitionOnlyBetweenListsOfSameLength}), it is enough to show that
          $C_{i_{o}} \Rightarrow_{\mathcal{S}^*} C_{i_{o}+1}$, but that is trivial and we are done.
\end{itemize}
\end{proof}

\begin{proof}[Proof of \Cref{thm:correspondence}]
We prove each implication separately.
\begin{enumerate}
    \item For the left-to-right implication, we
    let $\mathcal{S} = (\mathcal{T}, S)$
    and $\Psi \equiv  \exists \vec{X}.\, (\varphi_1,\ldots,\varphi_k) \land P$
    and $\Psi^\prime \equiv \exists \vec{Y}.\, (\varphi_1^\prime,\ldots,\varphi_k^\prime) \land P^\prime$,
    where $\varphi_j \equiv \phi_j \land P_j$,
    $\varphi^\prime_j \equiv \phi^\prime_j \land P^\prime_j$,
    and assume (i) that
    \begin{proofenv}
        for all configurations $c_1,\ldots,c_k \in \Tcfg$
    which terminate in $(\Tcfg, \Rightarrow_{\mathcal{S}})$
    and any two $\mathcal{T}$-valuation $\rho,\rho^\prime$
    satisfying $\rho(v) = \rho^\prime(v)$ for any $v \in \mathit{Var} \setminus (\vec{X} \cup \vec{Y})$,
    whenever $(\mathcal{T}, c_1,\rho) \vDash \varphi_1 \land P$ and \ldots
    and $(\mathcal{T}, c_k,\rho) \vDash \varphi_k \land Pi$,
    then there exist configurations $c_1^\prime,\ldots,c_k^\prime \in \Tcfg$
    such that $c_1 \Rightarrow^{*}_{\mathcal{S}} c_1^\prime$  
    and \ldots and $c_k \Rightarrow^{*}_{\mathcal{S}} c_k^\prime$,
    and
    $(\mathcal{T}, c_1^\prime,\rho^\prime) \vDash \varphi_1^\prime \land P^\prime$ and \ldots and $(\mathcal{T}, c_k^\prime, \rho^\prime) \vDash \varphi_k^\prime \land P^\prime$,
    \end{proofenv}
    and have to prove that
    \begin{proofenv}
    for every $C \in \mathcal{T}^*_{\mathit{Cfg}^*}$
    such that $C$ terminates in $(\mathcal{T}^*_{\mathit{Cfg}^*}, \Rightarrow_{\mathcal{S}^*})$
    and for any valuation $\rho : \Var^* \to \mathcal{T}^*$
    such that $(\mathcal{T}^*, C, \rho) \vDash \mathit{flatten}(\Psi)$,
    there exists some $C^\prime \in \mathcal{T}^*_{\mathit{Cfg}^*}$
    such that
    $C \Rightarrow^{*}_{\mathcal{S}^*} C^\prime$
    and $(\mathcal{T}^*, C^\prime, \rho) \vDash \mathit{flatten}(\Psi^\prime)$.
    \end{proofenv}
    Let us then have some $C \in \mathcal{T}^*_{\mathit{Cfg}^*}$
    such that $C$ terminates in $(\mathcal{T}^*_{\mathit{Cfg}^*}, \Rightarrow_{\mathcal{S}^*})$,
    and a valuation $\rho : \Var^* \to \mathcal{T}^*$
    such that $(\mathcal{T}^*, C, \rho) \vDash \mathit{flatten}(\Psi)$.
    We have to prove that
    \begin{proofenv}
    there exists some $C^\prime \in \mathcal{T}^*_{\mathit{Cfg}^*}$
    such that
    $C \Rightarrow^{*}_{\mathcal{S}^*} C^\prime$
    and $(\mathcal{T}^*, C^\prime, \rho) \vDash \mathit{flatten}(\Psi^\prime)$.
    \end{proofenv}
    We will proceed in five steps:
    \begin{enumerate}
        \item \label{item:corr:step1} We prove that there exists $c_1,\ldots,c_k$ such that $C = [c_1,\ldots, c_k]$.
        \item \label{item:corr:step2} We prove that $c_1,\ldots,c_k$ are terminating.
        \item \label{item:corr:step3} We find appropriate valuations $\rho_1 : \mathit{Var} \to \mathcal{T}$
              and prove the premise of the assumption (i): that $(\mathcal{T}, c_1, \rho_1) \vDash \varphi_1 \land P$
        and \ldots and $(\mathcal{T}, c_k, \rho_1) \vDash \varphi_k \land P$.
        \item \label{item:corr:step4} We choose some valuation $\rho_2 : \mathit{Var} \to \mathcal{T}$ satisfying $\rho_1(v) = \rho_2(v)$ for any $v \in \mathit{Var} \setminus (\vec{X} \cup \vec{Y})$, and from the assumption (i) we get the appropriate $c_1^\prime,\ldots,c_k^\prime$.
        \item \label{item:corr:step5} We let $C^\prime := [c_1^\prime,\ldots,c_k^\prime]$ and prove that it is reachable from $C$,
        as well as that it satisfies the flattened $\Psi^\prime$ in $\rho$.
    \end{enumerate}
    We have
    \begin{proofenv}
    $(\mathcal{T}^*, C, \rho) \vDash \mathit{flatten}(\Psi)$;
    \end{proofenv}
    that is,
    \begin{proofenv}
    \begin{equation*}
     (\mathcal{T}^*, C, \rho) \vDash \exists \vec{X}.\, \mathit{mkList}(\phi_1,\ldots,\phi_k) \land P \land P_1 \ldots \land P_k.
    \end{equation*}
    \end{proofenv}
    By \Cref{def:matchinglogic}, this is equivalent to
    \begin{proofenv}
    exists $\rho_0 : \mathit{Var}^* \to \mathcal{T}^*$ such that $\rho_0(v) = \rho(v)$ for any $v \in \mathit{Var}^* \setminus \vec{X}$ and
    \begin{enumerate}
        \item 
        \begin{equation*}
            (\mathcal{T}^*, C, \rho_0) \vDash \mathit{mkList}(\phi_1, \ldots, \phi_k)
        \end{equation*}
        \item 
        \begin{equation*}
            (\mathcal{T}^*, C, \rho_0) \vDash (P_1\land \ldots \land P_k) \land P
        \end{equation*}
    \end{enumerate}
    \end{proofenv}
    which is by \Cref{lem:mkListSemantics} equivalent to (ii)
    \begin{proofenv}
    exists $\rho_0 : \mathit{Var}^* \to \mathcal{T}^*$ such that $\rho_0(v) = \rho(v)$ for any $v \in \mathit{Var}^* \setminus \vec{X}$ and
    \begin{enumerate}
        \item there exists $c_1,\ldots,c_k \in \Tcfg$ such that $C = [c_1,\ldots,c_k]$
        and for every $\rho_0^\prime : \mathit{Var} \to \mathcal{T}$ satisfying $\rho_0^\prime(v) = \rho_0(v)$
        for any $v \in \mathit{FV}(\mathit{mkList}(\phi_1, \ldots, \phi_k))$, it holds that
        \begin{equation*}
            (\mathcal{T}, c_j, \rho_0^\prime) \vDash \phi_j
        \end{equation*}
        for any $j \in \{ 1, \ldots, k \}$; and
        \item
        \begin{equation*}
            (\mathcal{T}^*, C, \rho_0) \vDash (P_1 \land \ldots \land P_k) \land P \, .
        \end{equation*}
    \end{enumerate}
    \end{proofenv}
    Now, let $\rho_0$ be such valuation,
    and let $c_1,\ldots,c_k$ be such configurations. We have just proved Item~\ref{item:corr:step1}.
    To prove Item~\ref{item:corr:step2}, saying that the configurations $c_1, \ldots, c_k$ are terminating,
    we simply use \Cref{lem:terminationComposite}.
    Furthermore, by \Cref{lem:structurelessSemantics}, we have $(\mathcal{T}^*, \rho_0) \vDash P$.
    Now we want to prove Item~\ref{item:corr:step3}; that is, to find some valuation $\rho_1 : \mathit{Var} \to \mathcal{T}$
    such that for every $j \in \{ 1, \ldots, k \}$,
    $(\mathcal{T}, c_j, \rho_1) \vDash \varphi_j \land P$;
    that is, $(\mathcal{T}, c_j, \rho_1) \vDash \phi_j$ and $(\mathcal{T}, c_j, \rho_1) \vDash P_j \land P$.
    We let $\rho_1(v) := \rho_0(v)$ for every $v \in \mathit{Var}$.
    Then the first subgoal follows from the assumption; we have to only prove that $\rho_1(v) = \rho_0(v)$ for every
    $v \in \mathit{FV}(\mathit{mkList}(\phi_1,\ldots,\phi_k))$, which trivially follows from the definition of $\rho_1$.
    It remains to be proven that $(\mathcal{T}, c_j, \rho_1) \vDash P_j \land P$.
    We first use (ii.b) and \Cref{lem:unusedVariables} to derive
    \begin{equation*}
        (\mathcal{T}^*, C, \rho_{00}^*) \vDash (P_1 \land \ldots \land P_k) \land P
    \end{equation*}
    (where $\rho_{00}(v) = \rho_0(v)$ for any $v \in \mathit{Var}$),
    from which we derive (using \Cref{lem:starConservative}, \Cref{lem:structurelessSemantics}),
    and \Cref{def:matchinglogic}) that
    \begin{equation*}
        (\mathcal{T}^*, c_j, \rho_{00}) \vDash P_j \land P \, ,
    \end{equation*}
    from which
    \begin{equation*}
        (\mathcal{T}^*, c_j, \rho_1) \vDash P_j \land P
    \end{equation*}
    follows using \Cref{lem:unusedVariables}
    (
    because for any $v \in \mathit{FV}(P_j \land P)$, 
    $\rho_{00}(v) = \rho_0(v) = \rho_1(v)$
    ).
    \\
    We have just proved the premise of assumption (i),
    that is, Item~\ref{item:corr:step3}.
    It follows that
    \begin{proofenv}
        for any valuation $\rho_2 : \mathit{Var} \to \mathcal{T}$
        satisfying $\rho_2(v) = \rho_1(v)$ for any $v \in \mathit{Var} \setminus (\vec{X} \cup \vec{Y})$,
        there exist configurations $c_1^\prime,\ldots,c_k^\prime \in \Tcfg$ such that
        $c_1 \Rightarrow^*_{\mathcal{S}} c_1^\prime$ and \ldots and
        $c_k \Rightarrow^*_{\mathcal{S}} c_k^\prime$,
        and $(\mathcal{T}, c_1^\prime,\rho_2) \vDash \varphi_1^\prime \land P^\prime$ and \ldots and $(\mathcal{T}, c_k^\prime, \rho_2) \vDash \varphi_k^\prime \land P^\prime$.
    \end{proofenv}
    Let $\rho_2 : \mathit{Var} \to \mathcal{T}$ be defined by letting \jt{Currently the same but may differ in future}
    \begin{equation*}
        \rho_2(v) = 
        \begin{cases}
            \rho_1(v) & \text{if } v \not\in \vec{X} \cup \vec{Y} \\
            \rho_1(v) & \text{if } v \in \vec{X} \cup \vec{Y} \, .
        \end{cases}
    \end{equation*}
    Let $c_1^\prime,\ldots,c_k^\prime$ be such configurations.
    We choose $C^\prime := [ c_1^\prime,\ldots,c_k^\prime ]$,
    and it remains to be proven that
    \begin{proofenv}
        $C \Rightarrow^*_{\mathcal{S}^*} C^\prime$ and $(\mathcal{T}^*, C^\prime, \rho) \vDash \mathit{flatten}(\Psi^\prime)$ \,
    \end{proofenv}
    (where $\rho$ is the valuation that we started with).
    The part saying that $C \Rightarrow^*_{\mathcal{S}^*} C^\prime$ holds
    follows by \Cref{lem:reachComposite}. The other part,
    after unfolding $\Psi^\prime$ and $C^\prime$ and simplifying the definition of $\mathit{flatten}$,
    and applying \Cref{def:matchinglogic}
    becomes
    \begin{proofenv}
    exists $\rho_0^\prime : \mathit{Var}^* \to \mathcal{T}^*$ such that $\rho_0^\prime(v) = \rho(v)$ for any $v \in \mathit{Var}^* \setminus \vec{Y}$, and
    \begin{enumerate}
        \item 
        \begin{equation*}
            (\mathcal{T}^*, [ c_1^\prime,\ldots,c_k^\prime ], \rho_0^\prime) \vDash \mathit{mkList}(\phi_1^\prime, \ldots, \phi_k^\prime)
        \end{equation*}
        \item 
        \begin{equation*}
            (\mathcal{T}^*, [ c_1^\prime,\ldots,c_k^\prime ], \rho_0^\prime) \vDash (P_1^\prime \land \ldots \land P_k^\prime) \land P^\prime \, .
        \end{equation*}
    \end{enumerate}
    \end{proofenv}
    From earlier, we know that for every $j \in \{ 1, \ldots, k \}$,
    \begin{proofenv}
    $(\mathcal{T}, c_j^\prime, \rho_2) \vDash \varphi^\prime_j \land P^\prime$;    
    \end{proofenv}
    that is, after unfolding $\varphi^\prime_j$,
    \begin{proofenv}
        $(\mathcal{T}, c_j^\prime, \rho_2) \vDash \phi^\prime_j \land P^\prime_j \land P^\prime$.
    \end{proofenv}
    That is the same (by \Cref{def:matchinglogic}) as saying that
    \begin{proofenv}
        \begin{itemize}
            \item  $(\mathcal{T}, c_j^\prime, \rho_2) \vDash \phi^\prime_j$; and
            \item $(\mathcal{T}, c_j^\prime, \rho_2) \vDash P^\prime_j \land P^\prime$.
        \end{itemize}
    \end{proofenv}
    Now in the goal (starting with existential quantifier), let us define
    $\rho_0^\prime(v) = \rho_2(v)$ for any $v \in \mathit{Var}$ (and $\rho_0^\prime(w) = a$ for $w \in \mathit{Var}^* \setminus \mathit{Var}$, where $a$ is arbitrary).
    We verify that $\rho_0^\prime(v) = \rho_2(v) = \rho_1(v) = \rho_0(v) = \rho(v)$
    for any $v \in \mathit{Var}^* \setminus \vec{Y}$. (The last equality holds only because $\vec{X} \subseteq \vec{Y}$,
    as enforced by the CRL syntax.)
    %\\\hline\\
    We apply \Cref{lem:mkListSemantics} and \Cref{def:matchinglogic},
    and then we have to prove that
    \begin{proofenv}
    \begin{enumerate}
        \item $(\mathcal{T}, c_1^\prime, \rho_{00}^\prime) \vDash \phi_{1}^\prime$ and \ldots and $(\mathcal{T}, c_k^\prime, \rho_{00}^\prime) \vDash \phi_{k}^\prime$; and
        \item $(\mathcal{T}^*, [ c_1^\prime,\ldots,c_k^\prime ], \rho_0^\prime) \vDash P_{1}^\prime$ and \ldots and 
        $(\mathcal{T}^*, [ c_1^\prime,\ldots,c_k^\prime ], \rho_0^\prime) \vDash P_{k}^\prime$; and
        \item $(\mathcal{T}^*, [ c_1^\prime,\ldots,c_k^\prime ], \rho_0^\prime) \vDash P^\prime$.
    \end{enumerate}
    where $\rho^\prime_{00} : \mathit{Var} \to \mathcal{T}$ is
    arbitrary valuation satisfying
    $\rho^\prime_{00}(v) = \rho_0^\prime(v)$ for every $v \in \mathit{FV}(\mathit{mkList}(\phi_{i_1},\ldots,\phi_{i_k}))$.
    \end{proofenv}
    We now want to discharge the (a) part. Let $j \in \{ 1, \ldots, k \}$.
    We know from earlier that $(\mathcal{T}, c^\prime_j,\rho_2) \vDash \phi_{j}$,
    and want to prove that $(\mathcal{T}, c^\prime_j, \rho^\prime_{00}) \vDash \phi^\prime_{j}$.
    To do so, we apply \Cref{lem:unusedVariables}, and it remains to be proven that $\rho_{2}(v) = \rho^\prime_{00}(v)$
    for any $v \in \mathit{FV}(\phi^\prime_{j})$.
    But we know that for such $v$, $\rho^\prime_{00}(v) = \rho_0^\prime(v)$, so it is enough to show that
    $\rho_{2}(v) = \rho^\prime_0(v)$, which holds by the definition of $\rho^\prime_0$.
    For discharging the (b) and (c) part, we first use
    \Cref{lem:structurelessSemantics}
    to change the model element to the appropriate $c^\prime_j$,
    then use \Cref{lem:unusedVariables}
    to change the valuation to $(\rho_2)^*$ (since the $P$s contain only variables from $\mathit{Var}$),
    then strip the stars using \Cref{lem:starConservative} and notice that we already have appropriate assumptions.
    This concludes the proof.
    \item For the opposite implication, 
    we again assume that $\Psi \equiv (\varphi_1,\ldots,\varphi_k) \land P$,
    $\Psi^\prime \equiv \exists \vec{Y}.\, (\varphi_1^\prime,\ldots,\varphi_k^\prime) \land P^\prime$,
    $\varphi_j = \phi_j \land P_j$ and $\varphi^\prime_j = \phi^\prime_j \land P^\prime_j$ for any $j \in \{ 1, \ldots, k \}$,
    and assume that
    \begin{proofenv}
        \begin{equation*}
            \mathcal{S}^* \vDash_\RL \mathit{flatten}(\Psi) \Rightarrow^\exists \mathit{flatten}(\Psi^\prime) \, ;
        \end{equation*}
    \end{proofenv}
    that is (i),
    \begin{proofenv}
        for every $C \in \mathcal{T}^*_{\mathit{Cfg}^*}$ such that $C$ terminates in
        $(\mathcal{T}_{\mathit{Cfg}^*}, \Rightarrow_{\mathcal{S}^*})$
        and for any valuation $\rho : \mathit{Var}^* \to \mathcal{T}^*$ such that
        $(\mathcal{T}^*, C, \rho) \vDash \mathit{flatten}(\Psi)$,
        there exists some $C^\prime \in \mathcal{T}^*_{\mathit{Cfg}^*}$ such that
        $C \Rightarrow_{\mathcal{S}^*}^* C^\prime$
        and $(\mathcal{T}^*, C^\prime, \rho) \vDash \mathit{flatten}(\Psi^\prime)$;
    \end{proofenv}
    we have to prove that
    \begin{proofenv}
        \begin{equation*}
            \mathcal{S} \vDash_\CRL \Psi \Rightarrow^{c\exists} \Psi^\prime \, ;
        \end{equation*}
    \end{proofenv}
    that is,
    \begin{proofenv}
        for all configurations $c_1,\ldots,c_k \in \mathcal{T}_{\mathit{Cfg}}$ which terminate
        in $(\mathcal{T}_{\mathit{Cfg}}, \Rightarrow_{\mathcal{S}})$
        and any two valuations $\rho_1,\rho_2 : \mathit{Var} \to \mathcal{T}$ satisfying
        $\rho_1(v) = \rho_2(v)$ for any $v \in \mathit{Var} \setminus \vec{Y}$,
        whenever $(\mathcal{T}, c_1, \rho_1) \vDash \varphi_1 \land P$
        and \ldots and $(\mathcal{T}, c_k, \rho_1) \vDash \varphi_k \land P$,
        then there exists configurations $c^\prime_1, \ldots, c^\prime_k \in \mathcal{T}_{\mathit{Cfg}}$
        such that $c_1 \Rightarrow_{\mathcal{S}}^* c^\prime_1$ and \ldots
        and $c_k \Rightarrow_{\mathcal{S}}^* c^\prime_k$,
        and $(\mathcal{T}, c^\prime_1, \rho_2) \vDash \varphi^\prime_1 \land P$
        and \ldots and $(\mathcal{T}, c^\prime_k, \rho_2) \vDash \varphi^\prime_k \land P$.
    \end{proofenv}
    Let us then have such terminating configurations $c_1,\ldots,c_k \in \mathcal{T}_{\mathit{Cfg}}$
    and such valuations $\rho_1,\rho_2 : \mathit{Var} \to \mathcal{T}$.
    We have to show that
    \begin{proofenv}
        there exists configurations $c^\prime_1, \ldots, c^\prime_k \in \mathcal{T}_{\mathit{Cfg}}$
        such that $c_1 \Rightarrow_{\mathcal{S}}^* c^\prime_1$ and \ldots
        and $c_k \Rightarrow_{\mathcal{S}}^* c^\prime_k$,
        and $(\mathcal{T}, c^\prime_1, \rho_2) \vDash \varphi^\prime_1 \land P$
        and \ldots and $(\mathcal{T}, c^\prime_k, \rho_2) \vDash \varphi^\prime_k \land P$.
    \end{proofenv}
    We will proceed in the following steps.
    \begin{enumerate}
        \item We prove the premise of (i) for $C := [c_1,\ldots,c_k]$, that is:
        \begin{enumerate}
            \item $[c_1,\ldots,c_k]$ terminates in $(\mathcal{T}_{\mathit{Cfg}^*}, \Rightarrow_{\mathcal{S}^*})$; and
            \item $(\mathcal{T}^*, [c_1,\ldots,c_k], \rho) \vDash \mathit{flatten}(\Psi)$ for some constructed valuation $\rho$.
        \end{enumerate}
        \item We ``destruct'' the obtained $C^\prime$ into $[c^\prime_1,\ldots,c^\prime_k]$;
        \item We prove the desired properties of $c^\prime_j$ from the properties of $C^\prime$.
    \end{enumerate}
    First, $[c_1,\ldots,c_k]$ is terminating by \Cref{lem:terminationComposite}.
    Next, we have to show that
    \begin{proofenv}
        \begin{equation*}
            (\mathcal{T}^*, [c_1,\ldots,c_k], \rho) \vDash \mathit{flatten}((\varphi_1,\ldots,\varphi_k) \land P) \, ;
        \end{equation*}
    \end{proofenv}
    that is,
    \begin{proofenv}
        \begin{equation*}
            (\mathcal{T}^*, [c_1,\ldots,c_k], \rho) \vDash \mathit{mkList}(\phi_1,\ldots,\phi_k) \land P \land P_1 \land \ldots P_k \, ,
        \end{equation*}
    \end{proofenv}
    which is by \Cref{def:matchinglogic} and \Cref{lem:structurelessSemantics} equivalent to
    \begin{proofenv}
        \begin{itemize}
            \item $(\mathcal{T}^*, [c_1,\ldots,c_k], \rho) \vDash \mathit{mkList}(\phi_1,\ldots,\phi_k)$
            \item $(\mathcal{T}^*, \rho) \vDash P$
            \item $(\mathcal{T}^*, \rho) \vDash P_j$ for any $j \in \{ 1, \ldots, k \} $.
        \end{itemize}
    \end{proofenv}
    Since $\mathit{FV}(P) \cup \mathit{FV}(P_1) \cup \ldots \cup \mathit{FV}(P_k) \subseteq \mathit{Var}$,
    we can discharge the second and third point by first replacing $\rho$ with $(\rho_1)^*$
    using \Cref{lem:unusedVariables},
    stripping the stars using \Cref{lem:starConservative}, and using assumptions
    ($(\mathcal{T}, c_j, \rho_1) \vDash \phi_j \land P_j \land P$)
    together with \Cref{def:matchinglogic} and \Cref{lem:unusedVariables}.
    By \Cref{lem:mkListSemantics}, the remaining goal becomes
    \begin{proofenv}
        for every $\rho^\prime : \mathit{Var} \to \mathit{T}$ satisfying
        $\rho^\prime(v) = \rho(v)$ for any $v \in \mathit{FV}(\mathit{mkList}(\phi_1,\ldots,\phi_k))$,
        it holds that $(\mathcal{T}, c_j, \rho^\prime) \vDash \phi_j$
        for every $j \in \{ 1, \ldots, k \}$
    \end{proofenv}
    which is again discharded by assumption, \Cref{def:matchinglogic}, and \Cref{lem:unusedVariables}.
    Now we have obtained the following:
    \begin{proofenv}
        there exists some $C^\prime \in \mathcal{T}_{\mathit{Cfg}}^*$ such that
        $[c_1,\ldots,c_k] \Rightarrow_{\mathcal{S}^*}^* C^\prime$
        and $(\mathcal{T}^*, C^\prime, \rho) \vDash \mathit{flaten}(\Psi^\prime)$.
    \end{proofenv}
    Now, by \Cref{lem:transitionOnlyBetweenListsOfSameLength} (and using induction on the length of the
    sequence witnessing the reachability),
    we get some $c^\prime_1,\ldots,c^\prime_k \in \Tcfg$ such that
    \begin{proofenv}
        $[c_1,\ldots,c_k] \Rightarrow_{\mathcal{S}^*}^* [c^\prime_1,\ldots,c^\prime_k]$
        and $(\mathcal{T}^*, [c^\prime_1,\ldots,c^\prime_k], \rho) \vDash \mathit{flaten}(\Psi^\prime)$.
    \end{proofenv}
    Our goal is to prove that
    \begin{proofenv}
        there exists configurations $c^\prime_1, \ldots, c^\prime_k \in \mathcal{T}_{\mathit{Cfg}}$
        such that $c_1 \Rightarrow_{\mathcal{S}}^* c^\prime_1$ and \ldots
        and $c_k \Rightarrow_{\mathcal{S}}^* c^\prime_k$,
        and $(\mathcal{T}, c^\prime_1, \rho_2) \vDash \varphi^\prime_1 \land P$
        and \ldots and $(\mathcal{T}, c^\prime_k, \rho_2) \vDash \varphi^\prime_k \land P$,
    \end{proofenv}
    so we choose $c^\prime_j := c^\prime_j$ and have to prove that
    \begin{proofenv}
        $c_1 \Rightarrow_{\mathcal{S}}^* c^\prime_1$ and \ldots
        and $c_k \Rightarrow_{\mathcal{S}}^* c^\prime_k$,
        and $(\mathcal{T}, c^\prime_1, \rho_2) \vDash \varphi^\prime_1 \land P$
        and \ldots and $(\mathcal{T}, c^\prime_k, \rho_2) \vDash \varphi^\prime_k \land P$.
    \end{proofenv}
    The first part follows from \Cref{lem:reachComposite};
    it remains to be proven that
    \begin{proofenv}
        $(\mathcal{T}, c^\prime_1, \rho_2) \vDash \varphi^\prime_1 \land P$
        and \ldots and $(\mathcal{T}, c^\prime_k, \rho_2) \vDash \varphi^\prime_k \land P$,
    \end{proofenv}
    and we already have
    \begin{proofenv}
        $(\mathcal{T}^*, [c^\prime_1,\ldots,c^\prime_k], \rho) \vDash \mathit{flaten}(\Psi^\prime)$ \, ;
    \end{proofenv}
    that is
    \begin{proofenv}
        $(\mathcal{T}^*, [c^\prime_1,\ldots,c^\prime_k], \rho) \vDash \exists \vec{Y}.\, \mathit{mkList}(\phi_1,\ldots,\phi_k) \land P^\prime \land P^\prime_1 \land \ldots \land P^\prime_k$.
    \end{proofenv}
    We also know that
    $\rho_1(v) = \rho_2(v)$ for any $v \in \mathit{Var} \setminus \vec{Y}$.
    TODO.
    
\end{enumerate}

Admitted.
\end{proof}


\begin{lemma}\label{lem:constrain}
  For any structureless pattens $P, Q, P_1, \ldots, P_m$
  and any basic patterns $\phi_1, \ldots, \phi_m$,
    \begin{align*}
        \vDash_\ML & \mathit{constrain}(P \lor Q, \exists x_1,\ldots,x_{n}.\, (\phi_1 \land P_1) \lor \ldots (\phi_m \land P_{m})) \leftrightarrow
        \\ & ( \mathit{constrain}(P, \exists x_1,\ldots,x_{n}.\, (\phi_1 \land P_1) \lor \ldots (\phi_m \land P_{m}))
        \\ & \ \mathit{constrain}(Q, \exists x_1,\ldots,x_{n}.\, (\phi_1 \land P_1) \lor \ldots (\phi_m \land P_{m})) ) \, .
    \end{align*}
\end{lemma}
\begin{proof}[Proof of \Cref{lem:constrain}]
Admitted.
\end{proof}

\begin{lemma}\label{lem:doubleconstrain}
    \begin{align*}
        \vDash_\ML & \mathit{constrain}(P , \mathit{constrain}(Q, \varphi))
        \leftrightarrow \mathit{constrain}(P \land Q, \varphi)
    \end{align*}
\end{lemma}
\begin{proof}[Proof of \Cref{lem:doubleconstrain}]
Admitted.
\end{proof}

\begin{lemma}\label{lem:constrainMergeComm}
    \begin{align*}
        \vDash_\ML & \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \mathit{constrain}(P, \varphi_i), \varphi_{i+1}, \ldots, \varphi_k) \\
        & \leftrightarrow \mathit{constrain}(P, \mathit{mergePatterns(\varphi_1, \ldots, \varphi_k)})
    \end{align*}
\end{lemma}
\begin{proof}[Proof of \Cref{lem:constrainMergeComm}]
Admitted.
\end{proof}

\begin{lemma}\label{lem:constrainAsConjunction}
    \begin{align*}
        \vDash_{\ML} & \mathit{constrain}(P, \varphi) \leftrightarrow \varphi \land P
    \end{align*}
\end{lemma}
\begin{proof}[Proof of \Cref{lem:constrainAsConjunction}]
Admitted.
\end{proof}


\begin{proof}[Proof of \Cref{lem:CRLalmostSoundness}]
By induction on the structure of the CRL proof. TODO
\begin{enumerate}
    \item If the proof ends with \emph{Reduce}, then we are done, since $\mathit{flatten}^\exists(\emptyset, \psi^\prime) = \emptyset$.
    
    \item If the proof ends with \emph{Reflexivity}, then we need to prove
    \begin{equation*}
        \mathcal{S}^*, \mathit{flatten}^\exists(E, \psi), \emptyset \vdash_\RL
          \mathit{flatten}^\exists(\psi, \psi) 
    \end{equation*}
    which we do by applying the Reflexivity proof rule.
    
    \item If the proof ends with \emph{Axiom}, then $\psi \in E$,
          and we have to prove that
          \begin{equation*}
            \mathcal{S}^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime) \vdash_\RL
            \mathit{flatten}^\prime(\psi, \psi^\prime)               \, .
          \end{equation*}
          By applying the Axiom proof rule of RL, it is enough to show that
          \begin{equation*}
              \mathit{flatten}^\prime(\psi, \psi^\prime) \in \mathit{flatten^\prime}(E, \psi^\prime) \, ,
          \end{equation*}
          which follows from $\psi \in E$.
          
    \item If the proof ends with \emph{Case}, then we have
        \begin{equation*}
            \mathcal{S}^*, \Bar{E}, \Bar{C} \vdash_\RL
            \mathit{flatten}^\exists((\varphi_1, \ldots, \varphi_{i-1}, \varphi_i, \varphi_{i+1}, \ldots, \varphi_k) \land P^\prime, \Psi^\prime)
        \end{equation*}
        and
        \begin{equation*}
            \mathcal{S}^*, \Bar{E}, \Bar{C} \vdash_\RL
            \mathit{flatten}^\exists((\varphi_1, \ldots, \varphi_{i-1}, \psi_i, \varphi_{i+1}, \ldots, \varphi_k) \land P^\prime, \Psi^\prime) 
        \end{equation*}
        as hypotheses, and we have to prove
        \begin{equation*}
            \mathcal{S}^*, \Bar{E}, \Bar{C} \vdash_\RL
            \mathit{flatten}^\exists((\varphi_1, \ldots, \varphi_{i-1}, (\varphi_i \lor \psi_i), \varphi_{i+1}, \ldots, \varphi_k) \land P^\prime, \Psi^\prime)               \, .
        \end{equation*}
        (where $\Bar{E} = \mathit{flatten}^\exists(E, \psi^\prime)$
         and $\Bar{C} = \mathit{flatten}^\exists(C, \psi^\prime)$
        ).
        After simplifications, we get
        \begin{align*}
            \mathcal{S}^*, \Bar{E}, \Bar{C} \vdash_\RL
            &
            \mathit{constrain}(P^\prime, \mathit{mergePatterns}((\varphi_1, \ldots, \varphi_{i-1}, \varphi_i, \varphi_{i+1}, \ldots, \varphi_k)))
            \\ & \Rightarrow^\exists
            \mathit{flatten}(\Psi^\prime)
        \end{align*}
        and
        \begin{align*}
            \mathcal{S}^*, \Bar{E}, \Bar{C} \vdash_\RL
            &
            \mathit{constrain}(P^\prime, \mathit{mergePatterns}((\varphi_1, \ldots, \varphi_{i-1}, \psi_i, \varphi_{i+1}, \ldots, \varphi_k)))
            \\ & \Rightarrow^\exists
            \mathit{flatten}(\Psi^\prime)
        \end{align*}
        as hypotheses,
        and have to prove
        \begin{align*}
            \mathcal{S}^*, \Bar{E}, \Bar{C} \vdash_\RL
            &
            \mathit{constrain}(P^\prime, \mathit{mergePatterns}((\varphi_1, \ldots, \varphi_{i-1}, (\varphi_i \lor \psi_i), \varphi_{i+1}, \ldots, \varphi_k)))
            \\ & \Rightarrow^\exists
            \mathit{flatten}(\Psi^\prime)
        \end{align*}
        Since
        \begin{align*}
            \mathcal{T}^* \vDash_\ML & \mathit{constrain}(P^\prime, \mathit{mergePatterns}((\varphi_1, \ldots, \varphi_{i-1}, (\varphi_i \lor \psi_i), \varphi_{i+1}, \ldots, \varphi_k))) \leftrightarrow \\
            & (\mathit{constrain}(P^\prime, \mathit{mergePatterns}((\varphi_1, \ldots, \varphi_{i-1}, \varphi_i, \varphi_{i+1}, \ldots, \varphi_k))) \\
            & \lor \mathit{constrain}(P^\prime, \mathit{mergePatterns}((\varphi_1, \ldots, \varphi_{i-1}, \psi_i, \varphi_{i+1}, \ldots, \varphi_k))))
        \end{align*}
        (where $\mathcal{S}^* = (\mathcal{T}^*, S)$),
        we can apply the Consequence RL rule on the goal, followed by a Case Analysis rule applied to the two hypotheses, and we are done.
        
    \item If the proof ends with \emph{Step},
      we can assume a structureless FOL formula $P^\prime$, a rule $\varphi \Rightarrow^\exists \varphi^\prime \in S$ such that
      $\mathcal{T} \vDash_\ML \varphi_i \leftrightarrow \mathit{constrain}(P^\prime, \varphi)$,
      and an induction hypothesis
      \begin{align*}
        (&\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(C \cup E, \Psi^\prime)), \emptyset \vdash_\RL
          \\ &
          \mathit{flatten}((\varphi_1, \ldots, \varphi_{i-1}, \mathit{constrain}(P^\prime, \varphi^\prime), \varphi_{i+1}, \ldots, \varphi_k) \land P) \Rightarrow^\exists \mathit{flatten}(\Psi^\prime)     
      \end{align*}
      and have to construct
      \begin{align*}
      & (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL \\
          & \mathit{flatten}((\varphi_1, \ldots, \varphi_{i-1}, \varphi_i, \varphi_{i+1}, \ldots, \varphi_k) \land P) \Rightarrow^\exists \mathit{flatten}(\Psi^\prime)    \, .
      \end{align*}
        By definition of $S^*$, we also have
        \begin{align*}
            (\mathit{heat}(L, \varphi, R) \Rightarrow^\exists \mathit{heat}(L, \varphi^\prime, R)) \in S^* \, .
        \end{align*}
      
    We apply the Transitivity rule with the second premise being our first inductive hypothesis, and it remains to prove the second premise, which is (after simplification)
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\exists(E, \psi^\prime), \mathit{flatten}^\exists(C, \psi^\prime)
        \\& \vdash_\RL
        \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi_i, \varphi_{i+1}, \ldots,                          \varphi_k))
        \\&\quad \Rightarrow^\exists
        \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \mathit{constrain}(P^\prime, \varphi^\prime), \varphi_{i+1}, \ldots, \varphi_k) ) \, .
    \end{align*}
    By Congruence lemma and our assumption $\mathcal{T} \vDash_\ML \varphi_i \leftrightarrow (\varphi \land \psi)$ (adding the star does not break anything, by conservativeness), we have
    \begin{align*}
        \mathcal{T}^* \vDash_\ML &
        \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi_i, \varphi_{i+1}, \ldots,                          \varphi_k))
        \\ & \leftrightarrow
        \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \mathit{constrain}(P^\prime, \varphi), \varphi_{i+1}, \ldots, \varphi_k)) \, ,
    \end{align*}
    and therefore we can apply the Consequence rule on the goal, changing it into
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\& \vdash_\RL
        \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \mathit{constrain}(P^\prime, \varphi), \varphi_{i+1}, \ldots,                          \varphi_k))
        \\&\quad \Rightarrow^\exists
        \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \mathit{constrain}(P^\prime, \varphi^\prime), \varphi_{i+1}, \ldots, \varphi_k)) \, .
    \end{align*}
    Now we apply Consequence again using \Cref{lem:constrainMergeComm},
    changing the goal into
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\& \vdash_\RL
        \mathit{constrain}(P, \mathit{constrain}(P^\prime, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi, \varphi_{i+1}, \ldots, \varphi_k)))
        \\&\quad \Rightarrow^\exists
        \mathit{constrain}(P, \mathit{constrain}(P^\prime, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi^\prime, \varphi_{i+1}, \ldots, \varphi_k))) \, .
    \end{align*}
    Now apply Consequence again using \Cref{lem:doubleconstrain},
    changing the goal into
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\& \vdash_\RL
        \mathit{constrain}(P \land P^\prime, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi, \varphi_{i+1}, \ldots, \varphi_k))
        \\&\quad \Rightarrow^\exists
        \mathit{constrain}(P \land P^\prime, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi^\prime, \varphi_{i+1}, \ldots, \varphi_k)) \, ,
    \end{align*}
    and once again using \Cref{lem:constrainAsConjunction}, changing the goal into
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\& \vdash_\RL
        \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi, \varphi_{i+1}, \ldots, \varphi_k)
        \land (P \land P^\prime)
        \\&\quad \Rightarrow^\exists
        \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi^\prime, \varphi_{i+1}, \ldots, \varphi_k) \land (P \land P^\prime) \, ,
    \end{align*}
    Now we strip $P \land P^\prime$ by applying Logic Framing, resulting in the goal
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\& \vdash_\RL
        \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi, \varphi_{i+1}, \ldots, \varphi_k)
        \\&\quad \Rightarrow^\exists
        \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_{i-1}, \varphi^\prime, \varphi_{i+1}, \ldots, \varphi_k) \, .
    \end{align*}
    We apply Consequence again, changing the goal to
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\ \vdash_\RL &
        \bigvee_{i_1=1}^{m_1} \ldots \bigvee_{i_{j-1}=1}^{m_{j-1}}
        \bigvee_{i_{j+1}=1}^{m_{j+1}} \ldots \bigvee_{i_n=1}^{m_n}
        \exists \vec{X_1} \ldots \vec{X_{j-1}} \vec{X_{j+1}} \ldots \vec{X_n}
        \\& \exists \vec{X_j} \bigvee_{i_j=1}^{m_j} (\mathit{cfgheat}(L, \phi_{j, i_j}, R) \land P_{j, i_j}
        \\&\quad \land (L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}}))
        \\&\quad \land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\quad \land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n}))
        \\ \Rightarrow^\exists &
        \bigvee_{i_1=1}^{m_1} \ldots \bigvee_{i_{j-1}=1}^{m_{j-1}}
        \bigvee_{i_{j+1}=1}^{m_{j+1}} \ldots \bigvee_{i_n=1}^{m_n}
        \exists \vec{X_1} \ldots \vec{X_{j-1}} \vec{X_{j+1}} \ldots \vec{X_n}
        \\& \exists \vec{X^\prime_j} \bigvee_{i^\prime_j=1}^{m^\prime_j} (\mathit{cfgheat}(L, \phi^\prime_{j, i^\prime_j}, R) \land P^\prime_{j, i^\prime_j}
        \\&\quad \land (L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}}))
        \\&\quad \land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\quad \land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n}))
    \end{align*}
    where $\exists \vec{X_j}.\, \bigvee_{i_j = 1}^{m_j} (\phi_{i_j} \land P_{i_j}) = \varphi $
    and $\exists \vec{X_j^\prime}.\, \bigvee_{i_j^\prime = 1}^{m_j^\prime} (\phi_{i_j^\prime} \land P_{i_j}^\prime) = \varphi^\prime$.
    Now we iteratively apply Case Analysis, followed by Consequence where on the RHS of $\Rightarrow^\exists$ we select the disjunct corresponding to the LHS.
    We end up with a bunch of goals of the shape
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\ \vdash_\RL &
        \exists \vec{X_1} \ldots \vec{X_{j-1}} \vec{X_{j+1}} \ldots \vec{X_n}
        \\& \exists \vec{X_j} \bigvee_{i_j=1}^{m_j} (\mathit{cfgheat}(L, \phi_{j, i_j}, R) \land P_{j, i_j}
        \\&\quad \land (L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}}))
        \\&\quad \land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\quad \land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n}))
        \\ \Rightarrow^\exists &
        \exists \vec{X_1} \ldots \vec{X_{j-1}} \vec{X_{j+1}} \ldots \vec{X_n}
        \\& \exists \vec{X^\prime_j} \bigvee_{i^\prime_j=1}^{m^\prime_j} (\mathit{cfgheat}(L, \phi^\prime_{j, i^\prime_j}, R) \land P^\prime_{j, i^\prime_j}
        \\&\quad \land (L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}}))
        \\&\quad \land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\quad \land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n})) \, .
    \end{align*}
    Now we strip the quantifiers using Abstraction followed by Consequence,
    leading to goals of the shape
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\ \vdash_\RL &
        \exists \vec{X_j} \bigvee_{i_j=1}^{m_j} (\mathit{cfgheat}(L, \phi_{j, i_j}, R) \land P_{j, i_j}
        \\&\quad \land (L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}}))
        \\&\quad \land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\quad \land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n}))
        \\ \Rightarrow^\exists &
        \exists \vec{X^\prime_j} \bigvee_{i^\prime_j=1}^{m^\prime_j} (\mathit{cfgheat}(L, \phi^\prime_{j, i^\prime_j}, R) \land P^\prime_{j, i^\prime_j}
        \\&\quad \land (L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}}))
        \\&\quad \land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\quad \land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n})) \, .
    \end{align*}
    Since variables from $\vec{X_j}$ and $\vec{X_j^\prime}$ can occur only in $\phi_{j, i_j}$,
    $\phi^\prime_{j, i_j}$, $P_{j, i_j}$ and $P^\prime_{j, i_j}$, we can change the goals
    (using Consequence) into
    \begin{align*}
        & (\mathcal{T}, S)^*, \mathit{flatten}^\prime(E, \psi^\prime), \mathit{flatten}^\prime(C, \psi^\prime)
        \\ \vdash_\RL &
        (\exists \vec{X_j} \bigvee_{i_j=1}^{m_j} \mathit{cfgheat}(L, \phi_{j, i_j}, R) \land P_{j, i_j})
        \\&\land L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}})
        \\&\land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n})
        \\ \Rightarrow^\exists &
        (\exists \vec{X^\prime_j} \bigvee_{i^\prime_j=1}^{m^\prime_j} \mathit{cfgheat}(L, \phi^\prime_{j, i^\prime_j}, R) \land P^\prime_{j, i^\prime_j})
        \\&\land L = \mathit{mkList}(\phi_{1, i_1}, \ldots, \phi_{j-1, i_{j-1}})
        \\&\land R = \mathit{mkList}(\phi_{j+1, i_{j+1}}, \ldots, \phi_{n, i_{n}})
        \\&\land (P_{1, i_1} \land \ldots \land P_{j-1, i_{j-1}} \land P_{j+1, i_{j+1}} \land \ldots \land P_{n, i_n}) \, .
    \end{align*}
    We conclude this case by applying Framing and Axiom.
    
    \item If the proof ends with \emph{Circularity}, we can assume
        \begin{align*}
            (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)),
            \mathit{flatten}^\exists(C \cup \{ \Psi \}, \Psi^\prime) \vdash_\RL
            \mathit{flatten}^\exists(\Psi, \Psi^\prime)
        \end{align*}
        which simplifies to
        \begin{align*}
            (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)),
            \mathit{flatten}^\exists(C, \Psi^\prime) \cup \mathit{flatten}^\exists(\{ \Psi \}, \Psi^\prime) \vdash_\RL
            \mathit{flatten}^\exists(\Psi, \Psi^\prime)
        \end{align*}
        and have to prove
        \begin{align*}
            (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)),
            \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
            \mathit{flatten}^\exists(\Psi, \Psi^\prime)
        \end{align*}
        which follows from the assumption by Circularity.
        
    \item If the proof ends with \emph{Conseq}, we can assume
    \begin{align*}
        \mathcal{T}^* \vDash_\ML \mathit{flatten}(\Phi) \rightarrow \mathit{flatten}(\Phi^\prime)
    \end{align*}
    and
    \begin{align*}
        (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \mathit{flatten}^\exists(\Phi^\prime, \Psi^\prime) \, ,
    \end{align*}
    and have to prove
    \begin{align*}
        (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \mathit{flatten}^\exists(\Phi, \Psi^\prime)  \, .
    \end{align*}
    The second assumption simplifies to
    \begin{align*}
        (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \mathit{flatten}(\Phi^\prime) \Rightarrow^\exists \mathit{flatten}(\Psi^\prime) \, ,
    \end{align*}
    while the goal to
    \begin{align*}
        (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \mathit{flatten}(\Phi) \Rightarrow^\exists \mathit{flatten}(\Psi^\prime) \, ;
    \end{align*}
    therefore, we can apply the \emph{Consequence} rule.        
        
        
    \item If the proof ends with \emph{Abstract},
    we assume
    \begin{align*}
        X \not\in \mathit{FV}(\Psi^\prime)
    \end{align*}
    and
    \begin{align*}
                (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \mathit{flatten}^\exists(\exists \vec{Y}.\, (\varphi_1, \ldots, \varphi_k) \land P, \Psi^\prime)
    \end{align*}
    and have to prove that
    \begin{align*}
                (\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \mathit{flatten}^\exists(\exists X,\vec{Y}.\, (\varphi_1, \ldots, \varphi_k) \land P, \Psi^\prime) \, .
    \end{align*}
    After simplifications, the second premise becomes
    \begin{align*}
            &(\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \\& \exists \vec{Y}.\, \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_k))
          \Rightarrow^\exists \mathit{flatten}(\Psi^\prime) \, ,
    \end{align*}
    while the goal becomes
    \begin{align*}
          &(\mathcal{T}^*, S^* \cup \mathit{flatten}^\exists(E, \Psi^\prime)), \mathit{flatten}^\exists(C, \Psi^\prime) \vdash_\RL
          \\&\exists X,\vec{Y}.\, \mathit{constrain}(P, \mathit{mergePatterns}(\varphi_1, \ldots, \varphi_k))
          \Rightarrow^\exists \mathit{flatten}(\Psi^\prime) \, .
    \end{align*}
    We prove the goal using the Abstraction rule
    (note that $X \not\in \mathit{FV}(\Psi^\prime)$ implies $X \not\in \mathit{FV}(\mathit{flatten}(\Psi^\prime))$).
    
    \end{enumerate}
\end{proof}
